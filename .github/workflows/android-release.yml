name: Android App Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version_name:
        description: 'Version name (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      version_code:
        description: 'Version code (optional, auto-generated if empty)'
        required: false
        default: ''
      release_notes:
        description: 'Release notes'
        required: false
        default: 'New release'
      create_release:
        description: 'Create GitHub Release'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write
  actions: read
  
jobs:
  build:
    name: Build Android App
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: '11076708'
          accept-android-sdk-licenses: true

      - name: Grant execute permission for gradlew
        working-directory: "Zabala Gailetak/android-app"
        run: chmod +x gradlew

      - name: Extract version from tag or input
        id: version
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            VERSION_NAME=${GITHUB_REF#refs/tags/v}
            VERSION_CODE=$(git rev-list --count HEAD)
          else
            VERSION_NAME="${{ github.event.inputs.version_name }}"
            if [ -n "${{ github.event.inputs.version_code }}" ]; then
              VERSION_CODE="${{ github.event.inputs.version_code }}"
            else
              # Format: YYMMDDHH (year, month, day, hour) - fits in Int until year 2100
              # Max value: 99123123 = 99,123,123 (Dec 31, 2099, 23h) < 2,147,483,647
              VERSION_CODE=$(date +%y%m%d%H)
            fi
          fi
          
          # Ensure version code is a valid positive integer
          if ! [[ "$VERSION_CODE" =~ ^[0-9]+$ ]]; then
            echo "Invalid version code: $VERSION_CODE, using timestamp fallback"
            VERSION_CODE=$(date +%y%m%d%H)
          fi
          
          # Ensure version code is not 0 and fits in Int (max 2147483647)
          if [ "$VERSION_CODE" -eq 0 ]; then
            VERSION_CODE=1
          elif [ "$VERSION_CODE" -gt 2147483647 ]; then
            echo "Version code too large: $VERSION_CODE, using modulo"
            VERSION_CODE=$((VERSION_CODE % 2147483647))
          fi
          
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "Building version $VERSION_NAME (code: $VERSION_CODE)"

      - name: Update version in build.gradle.kts
        working-directory: "Zabala Gailetak/android-app/app"
        run: |
          sed -i "s/versionCode[[:space:]]*=[[:space:]]*[0-9]\+/versionCode = ${{ steps.version.outputs.VERSION_CODE }}/" build.gradle.kts
          sed -i "s/versionName[[:space:]]*=[[:space:]]*\"[^\"]*\"/versionName = \"${{ steps.version.outputs.VERSION_NAME }}\"/" build.gradle.kts
          echo "Updated version to ${{ steps.version.outputs.VERSION_NAME }} (code: ${{ steps.version.outputs.VERSION_CODE }})"

      - name: Clean build
        working-directory: "Zabala Gailetak/android-app"
        run: ./gradlew clean --no-daemon

      - name: Build Debug APK
        working-directory: "Zabala Gailetak/android-app"
        run: ./gradlew assembleDebug --no-daemon --stacktrace
        timeout-minutes: 30

      - name: Build Release APK
        working-directory: "Zabala Gailetak/android-app"
        run: ./gradlew assembleRelease --no-daemon --stacktrace
        timeout-minutes: 30

      - name: Check keystore availability
        id: keystore_check
        run: |
          if [ -n "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "KEYSTORE_AVAILABLE=true" >> $GITHUB_OUTPUT
            echo "Keystore available"
          else
            echo "KEYSTORE_AVAILABLE=false" >> $GITHUB_OUTPUT
            echo "Using debug key"
          fi

      - name: Sign Release APK with Production Key
        if: steps.keystore_check.outputs.KEYSTORE_AVAILABLE == 'true'
        working-directory: "Zabala Gailetak/android-app"
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > zabala-gailetak-release.keystore
          BUILD_TOOLS_VERSION=$(ls -1 ${ANDROID_HOME}/build-tools 2>/dev/null | sort -V | tail -n 1)
          [ -z "$BUILD_TOOLS_VERSION" ] && BUILD_TOOLS_VERSION="34.0.0"
          
          ${ANDROID_HOME}/build-tools/${BUILD_TOOLS_VERSION}/apksigner sign \
            --ks zabala-gailetak-release.keystore \
            --ks-key-alias "$KEY_ALIAS" \
            --ks-pass "pass:$KEYSTORE_PASSWORD" \
            --key-pass "pass:$KEY_PASSWORD" \
            --out app/build/outputs/apk/release/app-release-signed.apk \
            app/build/outputs/apk/release/app-release-unsigned.apk
          
          ${ANDROID_HOME}/build-tools/${BUILD_TOOLS_VERSION}/apksigner verify app/build/outputs/apk/release/app-release-signed.apk
          rm -f zabala-gailetak-release.keystore

      - name: Sign Release APK with Debug Key
        if: steps.keystore_check.outputs.KEYSTORE_AVAILABLE != 'true'
        working-directory: "Zabala Gailetak/android-app"
        run: |
          BUILD_TOOLS_VERSION=$(ls -1 ${ANDROID_HOME}/build-tools 2>/dev/null | sort -V | tail -n 1)
          [ -z "$BUILD_TOOLS_VERSION" ] && BUILD_TOOLS_VERSION="34.0.0"
          
          keytool -genkey -v \
            -keystore debug.keystore \
            -alias androiddebugkey \
            -storepass android \
            -keypass android \
            -keyalg RSA \
            -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US"
          
          ${ANDROID_HOME}/build-tools/${BUILD_TOOLS_VERSION}/apksigner sign \
            --ks debug.keystore \
            --ks-key-alias androiddebugkey \
            --ks-pass "pass:android" \
            --key-pass "pass:android" \
            --out app/build/outputs/apk/release/app-release-signed.apk \
            app/build/outputs/apk/release/app-release-unsigned.apk
          
          rm -f debug.keystore

      - name: Rename APK files
        working-directory: "Zabala Gailetak/android-app/app/build/outputs/apk"
        run: |
          VERSION_NAME="${{ steps.version.outputs.VERSION_NAME }}"
          VERSION_CODE="${{ steps.version.outputs.VERSION_CODE }}"
          
          if [ -f "debug/app-debug.apk" ]; then
            mv debug/app-debug.apk "debug/zabala-gailetak-hrapp-v${VERSION_NAME}-debug.apk"
          fi
          
          if [ -f "release/app-release-signed.apk" ]; then
            if [ "${{ steps.keystore_check.outputs.KEYSTORE_AVAILABLE }}" == "true" ]; then
              mv release/app-release-signed.apk "release/zabala-gailetak-hrapp-v${VERSION_NAME}-release.apk"
            else
              mv release/app-release-signed.apk "release/zabala-gailetak-hrapp-v${VERSION_NAME}-debug-signed.apk"
            fi
          fi
          
          if [ -f "release/app-release-unsigned.apk" ]; then
            mv release/app-release-unsigned.apk "release/zabala-gailetak-hrapp-v${VERSION_NAME}-unsigned.apk"
          fi

      - name: Verify APK signatures
        working-directory: "Zabala Gailetak/android-app/app/build/outputs/apk"
        run: |
          BUILD_TOOLS_VERSION=$(ls -1 ${ANDROID_HOME}/build-tools 2>/dev/null | sort -V | tail -n 1)
          [ -z "$BUILD_TOOLS_VERSION" ] && BUILD_TOOLS_VERSION="34.0.0"
          
          for apk in $(find . -name "*.apk" 2>/dev/null); do
            echo "Checking: $apk"
            ${ANDROID_HOME}/build-tools/${BUILD_TOOLS_VERSION}/aapt dump badging "$apk" 2>/dev/null | grep -E "version" | head -2
            ${ANDROID_HOME}/build-tools/${BUILD_TOOLS_VERSION}/apksigner verify -v "$apk" 2>/dev/null && echo "Signature OK" || echo "Signature check failed"
          done

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zabala-gailetak-hrapp-debug
          path: "Zabala Gailetak/android-app/app/build/outputs/apk/debug/*.apk"
          retention-days: 30

      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: zabala-gailetak-hrapp-release
          path: "Zabala Gailetak/android-app/app/build/outputs/apk/release/*.apk"
          retention-days: 90

      - name: Generate checksums
        working-directory: "Zabala Gailetak/android-app/app/build/outputs/apk"
        run: |
          echo "## APK Checksums" > checksums.txt
          echo "" >> checksums.txt
          echo "Version: ${{ steps.version.outputs.VERSION_NAME }}" >> checksums.txt
          echo "Version Code: ${{ steps.version.outputs.VERSION_CODE }}" >> checksums.txt
          echo "" >> checksums.txt
          for apk in $(find . -name "*.apk" 2>/dev/null); do
            echo "File: $(basename $apk)" >> checksums.txt
            sha256sum "$apk" >> checksums.txt
            echo "" >> checksums.txt
          done
          cat checksums.txt

      - name: Upload checksums
        uses: actions/upload-artifact@v4
        with:
          name: apk-checksums
          path: "Zabala Gailetak/android-app/app/build/outputs/apk/checksums.txt"
          retention-days: 90

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    if: |
      always() && 
      needs.build.result == 'success' &&
      ((github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) || 
       (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true'))
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Organize artifacts
        run: |
          mkdir -p ./release
          find ./artifacts -name "*.apk" -type f -exec cp {} ./release/ \;
          find ./artifacts -name "checksums.txt" -type f -exec cp {} ./release/ \;
          ls -lh ./release/

      - name: Generate release notes
        run: |
          echo "# Zabala Gailetak HR App Release" > release_notes.md
          echo "" >> release_notes.md
          echo "## Installation Instructions" >> release_notes.md
          echo "" >> release_notes.md
          echo "### For Updates:" >> release_notes.md
          echo "1. Download the APK file with the SAME signing type as your current installation" >> release_notes.md
          echo "2. Open the APK - Android should show 'Update' option" >> release_notes.md
          echo "3. Tap Update to preserve your data" >> release_notes.md
          echo "" >> release_notes.md
          echo "### If Update Fails:" >> release_notes.md
          echo "1. Backup your data if needed" >> release_notes.md
          echo "2. Uninstall the old version" >> release_notes.md
          echo "3. Install the new APK" >> release_notes.md
          echo "4. Login again" >> release_notes.md
          echo "" >> release_notes.md
          echo "### APK Types:" >> release_notes.md
          echo "- \`*-release.apk\` - Production signed (recommended)" >> release_notes.md
          echo "- \`*-debug-signed.apk\` - Debug signed (for testing)" >> release_notes.md
          echo "- \`*-debug.apk\` - Debug build (development only)" >> release_notes.md
          echo "" >> release_notes.md
          echo "## Notes" >> release_notes.md
          echo "- Version code must be higher than installed version for updates" >> release_notes.md
          echo "- Different signing keys require clean install (data loss)" >> release_notes.md
          echo "- Verify SHA-256 checksum before installing" >> release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.event.inputs.version_name || github.ref_name }}
          name: Zabala Gailetak HR App v${{ github.event.inputs.version_name || github.ref_name }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: ./release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
