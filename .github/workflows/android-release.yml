name: Android App Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v1.2.3
  workflow_dispatch:
    inputs:
      version_name:
        description: 'Version name (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      version_code:
        description: 'Version code (integer)'
        required: true
        default: '1'
      release_notes:
        description: 'Release notes'
        required: false
        default: 'New release'
      create_release:
        description: 'Create GitHub Release (requires signed APK)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  build:
    name: ðŸ—ï¸ Build Android App
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: '11076708'
          accept-android-sdk-licenses: true

      - name: Verify Java version
        run: |
          echo "JAVA_HOME: $JAVA_HOME"
          java -version
          javac -version

      - name: Grant execute permission for gradlew
        working-directory: "Zabala Gailetak/android-app"
        run: chmod +x gradlew

      - name: Verify Gradle wrapper
        working-directory: "Zabala Gailetak/android-app"
        run: |
          ./gradlew --version
          ./gradlew tasks --all | head -20

      - name: Extract version from tag or input
        id: version
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            VERSION_NAME=${GITHUB_REF#refs/tags/v}
            VERSION_CODE=$(git rev-list --count HEAD)
          else
            VERSION_NAME="${{ github.event.inputs.version_name }}"
            VERSION_CODE="${{ github.event.inputs.version_code }}"
          fi
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "Building version $VERSION_NAME (code: $VERSION_CODE)"

      - name: Update version in build.gradle.kts
        working-directory: "Zabala Gailetak/android-app/app"
        run: |
          sed -i "s/versionCode[[:space:]]*=[[:space:]]*[0-9]\+/versionCode = ${{ steps.version.outputs.VERSION_CODE }}/" build.gradle.kts
          sed -i "s/versionName[[:space:]]*=[[:space:]]*\"[^\"]*\"/versionName = \"${{ steps.version.outputs.VERSION_NAME }}\"/" build.gradle.kts
          echo "Updated version to ${{ steps.version.outputs.VERSION_NAME }} (code: ${{ steps.version.outputs.VERSION_CODE }})"
          cat build.gradle.kts | grep -A2 "versionCode\|versionName"

      - name: Clean build
        working-directory: "Zabala Gailetak/android-app"
        run: ./gradlew clean --no-daemon

      - name: Build Debug APK
        working-directory: "Zabala Gailetak/android-app"
        run: ./gradlew assembleDebug --no-daemon --stacktrace
        timeout-minutes: 30

      - name: Build Release APK
        working-directory: "Zabala Gailetak/android-app"
        run: ./gradlew assembleRelease --no-daemon --stacktrace
        timeout-minutes: 30

      - name: List output files
        working-directory: "Zabala Gailetak/android-app"
        run: |
          echo "=== APK Outputs ==="
          find app/build/outputs/apk -name "*.apk" -type f 2>/dev/null || echo "No APKs found"
          echo "=== Directory structure ==="
          ls -la app/build/outputs/apk/ 2>/dev/null || echo "Directory not found"

      - name: Sign Release APK
        # Sign on tag push OR manual dispatch when creating release
        if: |
          (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
        working-directory: "Zabala Gailetak/android-app"
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          # Check if keystore secret is available
          if [ -z "$KEYSTORE_BASE64" ]; then
            echo "âš ï¸ Warning: KEYSTORE_BASE64 not set, skipping signing"
            exit 0
          fi
          
          # Decode keystore from base64
          echo "$KEYSTORE_BASE64" | base64 -d > zabala-gailetak-release.keystore
          
          # Find latest build-tools version (fallback to 34.0.0)
          BUILD_TOOLS_VERSION=$(ls -1 ${ANDROID_HOME}/build-tools 2>/dev/null | sort -V | tail -n 1)
          if [ -z "$BUILD_TOOLS_VERSION" ]; then
            BUILD_TOOLS_VERSION="34.0.0"
          fi
          echo "Using build-tools version: $BUILD_TOOLS_VERSION"
          
          # Check if release APK exists
          if [ ! -f "app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
            echo "Error: app-release-unsigned.apk not found"
            ls -la app/build/outputs/apk/release/ 2>/dev/null || echo "Release directory not found"
            exit 1
          fi
          
          # Sign the APK
          ${ANDROID_HOME}/build-tools/${BUILD_TOOLS_VERSION}/apksigner sign \
            --ks zabala-gailetak-release.keystore \
            --ks-key-alias "$KEY_ALIAS" \
            --ks-pass "pass:$KEYSTORE_PASSWORD" \
            --key-pass "pass:$KEY_PASSWORD" \
            --out app/build/outputs/apk/release/zabala-gailetak-hrapp-v${{ steps.version.outputs.VERSION_NAME }}-signed.apk \
            app/build/outputs/apk/release/app-release-unsigned.apk
          
          # Verify signature
          ${ANDROID_HOME}/build-tools/${BUILD_TOOLS_VERSION}/apksigner verify \
            app/build/outputs/apk/release/zabala-gailetak-hrapp-v${{ steps.version.outputs.VERSION_NAME }}-signed.apk
          
          # Clean up keystore
          rm zabala-gailetak-release.keystore

      - name: Rename APK files
        working-directory: "Zabala Gailetak/android-app/app/build/outputs/apk"
        run: |
          # Rename debug APK
          if [ -f "debug/app-debug.apk" ]; then
            mv debug/app-debug.apk debug/zabala-gailetak-hrapp-v${{ steps.version.outputs.VERSION_NAME }}-debug.apk
            echo "Debug APK renamed"
          else
            echo "Warning: app-debug.apk not found"
            ls -la debug/ 2>/dev/null || echo "Debug directory not found"
          fi
          
          # Rename release APK (unsigned if not creating release)
          if [ -f "release/app-release-unsigned.apk" ]; then
            mv release/app-release-unsigned.apk release/zabala-gailetak-hrapp-v${{ steps.version.outputs.VERSION_NAME }}-release-unsigned.apk
            echo "Release APK renamed"
          fi

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zabala-gailetak-hrapp-debug
          path: "Zabala Gailetak/android-app/app/build/outputs/apk/debug/*.apk"
          retention-days: 30
          if-no-files-found: warn

      - name: Upload Release APK (unsigned)
        if: |
          (github.event_name != 'push' || !startsWith(github.ref, 'refs/tags/')) &&
          !(github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
        uses: actions/upload-artifact@v4
        with:
          name: zabala-gailetak-hrapp-release-unsigned
          path: "Zabala Gailetak/android-app/app/build/outputs/apk/release/*unsigned*.apk"
          retention-days: 30
          if-no-files-found: warn

      - name: Upload Release APK (signed)
        if: |
          (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
        uses: actions/upload-artifact@v4
        with:
          name: zabala-gailetak-hrapp-release-signed
          path: "Zabala Gailetak/android-app/app/build/outputs/apk/release/*signed*.apk"
          retention-days: 90
          if-no-files-found: warn

      - name: Generate APK checksums
        working-directory: "Zabala Gailetak/android-app/app/build/outputs/apk"
        run: |
          echo "## APK Checksums" > checksums.txt
          echo "" >> checksums.txt
          for apk in $(find . -name "*.apk" 2>/dev/null); do
            echo "### $(basename $apk)" >> checksums.txt
            echo '```' >> checksums.txt
            sha256sum "$apk" >> checksums.txt
            echo '```' >> checksums.txt
            echo "" >> checksums.txt
          done
          cat checksums.txt

      - name: Upload checksums
        uses: actions/upload-artifact@v4
        with:
          name: apk-checksums
          path: "Zabala Gailetak/android-app/app/build/outputs/apk/checksums.txt"
          retention-days: 90
          if-no-files-found: ignore

  release:
    name: ðŸ“¦ Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    # Create release on tag push OR manual workflow dispatch (when requested)
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag or input
        id: version
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            VERSION_NAME=${GITHUB_REF#refs/tags/v}
          else
            VERSION_NAME="${{ github.event.inputs.version_name }}"
          fi
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "Version: $VERSION_NAME"

      - name: Download signed APK
        uses: actions/download-artifact@v4
        with:
          name: zabala-gailetak-hrapp-release-signed
          path: ./artifacts

      - name: Download checksums
        uses: actions/download-artifact@v4
        with:
          name: apk-checksums
          path: ./artifacts
          if-no-files-found: ignore

      - name: List artifacts
        run: |
          echo "=== Downloaded artifacts ==="
          ls -la ./artifacts/

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          # Zabala Gailetak HR App v${{ steps.version.outputs.VERSION_NAME }}
          
          ## ðŸ“± Android Application Release
          
          ### What's New
          ${{ github.event.inputs.release_notes || 'See commit history for details.' }}
          
          ### ðŸ“¥ Installation
          
          1. Download the `zabala-gailetak-hrapp-v${{ steps.version.outputs.VERSION_NAME }}-signed.apk` file below
          2. On your Android device, enable "Install from Unknown Sources" in Settings
          3. Open the downloaded APK file to install
          4. Launch the app and login with your credentials
          
          ### ðŸ”’ Security
          
          - This APK is signed with our release keystore
          - Verify the SHA-256 checksum matches the one in `checksums.txt`
          - Only install from official GitHub releases
          
          ### ðŸ“Š Technical Details
          
          - **Version Name:** ${{ steps.version.outputs.VERSION_NAME }}
          - **Min SDK:** 24 (Android 7.0)
          - **Target SDK:** 35 (Android 15)
          - **Architecture:** Universal APK (arm64-v8a, armeabi-v7a, x86, x86_64)
          
          ### ðŸ› Known Issues
          
          - None reported yet
          
          ### ðŸ“ Changelog
          
          See full commit history: [Commits](https://github.com/${{ github.repository }}/commits/${{ github.ref_name }})
          
          ---
          
          **Built with:** Kotlin 2.0.21 â€¢ Jetpack Compose â€¢ Material 3 Design  
          **Build Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")  
          **Git Commit:** ${{ github.sha }}
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION_NAME }}
          name: Zabala Gailetak HR App v${{ steps.version.outputs.VERSION_NAME }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            ./artifacts/*.apk
            ./artifacts/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: ðŸ“¢ Notify Team
    needs: [build, release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Build Status Summary
        run: |
          echo "## Android App Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Status:** ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Status:** ${{ needs.release.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "âœ… **Android app built successfully!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Build failed. Check logs for details.**" >> $GITHUB_STEP_SUMMARY
          fi
