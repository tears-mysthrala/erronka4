################################################################################
# ModSecurity WAF Configuration
# Zabala Gailetak - Web Application Firewall
# OWASP Core Rule Set Integration
################################################################################

# ============================================================================
# CONFIGURACIÓN BÁSICA
# ============================================================================

# Habilitar ModSecurity
SecRuleEngine On

# Modo de detección (On, DetectionOnly, Off)
# Production: On
# Testing: DetectionOnly
SecRuleEngine On

# Configuración de auditoría
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/modsec_audit.log

# Directorio de datos
SecDataDir /tmp

# ============================================================================
# CONFIGURACIÓN DE REGISTRO (LOGGING)
# ============================================================================

SecDebugLog /var/log/modsec_debug.log
SecDebugLogLevel 0

# ============================================================================
# LÍMITES Y TAMAÑOS
# ============================================================================

# Tamaño máximo de body
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072

# Inspeccionar body de requests
SecRequestBodyAccess On

# Inspeccionar body de respuestas
SecResponseBodyAccess On
SecResponseBodyLimit 524288
SecResponseBodyMimeType text/plain text/html text/xml application/json

# ============================================================================
# PROTECCIÓN DE ARCHIVOS
# ============================================================================

# Permitir archivos multipart
SecUploadKeepFiles Off

# ============================================================================
# CONFIGURACIÓN DE COOKIES
# ============================================================================

SecCookieFormat 0
SecArgumentSeparator &
SecStatusEngine Off

# ============================================================================
# REGLAS PERSONALIZADAS - ZABALA GAILETAK
# ============================================================================

# ----------------------------------------------------------------------------
# RATE LIMITING - Prevenir fuerza bruta
# ----------------------------------------------------------------------------

# Limitar intentos de login
SecAction "id:1000,phase:1,nolog,pass,initcol:ip=%{REMOTE_ADDR}"

SecRule REQUEST_URI "@contains /api/auth/login" \
    "id:1001,phase:2,block,log,msg:'Rate limit exceeded for login',\
    setvar:ip.login_attempts=+1,expirevar:ip.login_attempts=300,\
    chain"
    SecRule IP:LOGIN_ATTEMPTS "@gt 5" \
        "t:none,setvar:ip.login_block=1,expirevar:ip.login_block=3600"

# Bloquear IP si excede rate limit
SecRule IP:LOGIN_BLOCK "@eq 1" \
    "id:1002,phase:1,deny,status:429,msg:'IP blocked due to rate limiting',\
    logdata:'Rate limit exceeded for IP: %{remote_addr}'"

# ----------------------------------------------------------------------------
# PROTECCIÓN CONTRA SQL INJECTION
# ----------------------------------------------------------------------------

SecRule REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_FILENAME|ARGS_NAMES|ARGS|XML:/* \
    "@rx (?i:(select\s*\*\s*from|union\s*select|insert\s*into|delete\s*from|drop\s*table|exec\s*\(|execute\s*\(|benchmark\s*\(|sleep\s*\(|waitfor\s*delay))" \
    "id:2001,phase:2,deny,status:403,msg:'SQL Injection detected',\
    logdata:'Matched SQLi pattern: %{matched_var}',tag:'application-multi',tag:'language-multi',tag:'platform-multi',tag:'attack-sqli',tag:'OWASP_CRS/WEB_ATTACK/SQL_INJECTION'"

# ----------------------------------------------------------------------------
# PROTECCIÓN CONTRA XSS
# ----------------------------------------------------------------------------

SecRule REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_FILENAME|ARGS_NAMES|ARGS|XML:/* \
    "@rx (?i:(<script[^>]*>[\\s\\S]*?</script>|<javascript:[^>]*>|<iframe[^>]*>[\\s\\S]*?</iframe>|<object[^>]*>[\\s\\S]*?</object>|<embed[^>]*>|<form[^>]*>|<input[^>]*type\\s*=\\s*[\"']?file))" \
    "id:3001,phase:2,deny,status:403,msg:'Cross-site Scripting detected',\
    logdata:'Matched XSS pattern: %{matched_var}',tag:'application-multi',tag:'language-multi',tag:'platform-multi',tag:'attack-xss'"

# ----------------------------------------------------------------------------
# PROTECCIÓN CSRF
# ----------------------------------------------------------------------------

# Verificar Origin/Referer para operaciones sensibles
SecRule REQUEST_URI "@contains /api/" \
    "id:4001,phase:1,block,log,msg:'Missing Origin header',\
    chain"
    SecRule REQUEST_HEADERS:Origin "@eq ''" \
        "t:none,deny,status:403,logdata:'CSRF protection: Missing Origin header'"

# ----------------------------------------------------------------------------
# RESTRICCIÓN DE MÉTODOS HTTP
# ----------------------------------------------------------------------------

SecRule REQUEST_METHOD "!^(GET|HEAD|POST|PUT|DELETE|OPTIONS)$" \
    "id:5001,phase:1,deny,status:405,msg:'Method not allowed',\
    logdata:'Method: %{request_method}'"

# ----------------------------------------------------------------------------
# PROTECCIÓN DE CABECERAS
# ----------------------------------------------------------------------------

# Requerir Host header
SecRule REQUEST_HEADERS:Host "^$" \
    "id:6001,phase:1,deny,status:400,msg:'Missing Host header'"

# Limitar tamaño de User-Agent
SecRule REQUEST_HEADERS:User-Agent "@gt 512" \
    "id:6002,phase:1,deny,status:400,msg:'User-Agent too long'"

# ----------------------------------------------------------------------------
# BLOQUEO DE IP MALICIOSAS
# ----------------------------------------------------------------------------

# Lista de IPs bloqueadas (ejemplo)
# SecRule REMOTE_ADDR "@ipMatch 192.168.1.100,10.0.0.50" \
#     "id:7001,phase:1,deny,status:403,msg:'Blocked IP'"

# ----------------------------------------------------------------------------
# PROTECCIÓN DE ARCHIVOS SENSIBLES
# ----------------------------------------------------------------------------

SecRule REQUEST_FILENAME "@rx (\\.env|\\.git|\\.svn|\\.htaccess|web\\.config|config\\.xml|phpinfo\\.php)" \
    "id:8001,phase:1,deny,status:403,msg:'Attempt to access sensitive file',\
    logdata:'File: %{request_filename}'"

# ----------------------------------------------------------------------------
# PROTECCIÓN CONTRA PATH TRAVERSAL
# ----------------------------------------------------------------------------

SecRule REQUEST_FILENAME|ARGS "@rx (\\.\\./|\\.\\.\\|%2e%2e%2f|%2e%2e/)" \
    "id:9001,phase:1,deny,status:403,msg:'Path traversal detected',\
    logdata:'Matched: %{matched_var}'"

# ----------------------------------------------------------------------------
# PROTECCIÓN CONTRA COMMAND INJECTION
# ----------------------------------------------------------------------------

SecRule ARGS|ARGS_NAMES "@rx [;&|`<>
\\(\\)\\{\\}\\[\\]]" \
    "id:10001,phase:2,deny,status:403,msg:'Command injection detected',\
    logdata:'Matched character: %{matched_var}'"

# ----------------------------------------------------------------------------
# PROTECCIÓN DE UPLOADS
# ----------------------------------------------------------------------------

# Limitar extensiones de archivo permitidas
SecRule REQUEST_FILENAME "@contains /upload" \
    "id:11001,phase:2,block,log,msg:'Upload detected',\
    chain"
    SecRule REQUEST_BODY "@rx filename=\"[^\"]*\\.(php|phps|phtml|php3|php4|php5|pl|py|jsp|asp|aspx|sh|bash|exe|dll)\"" \
        "t:none,deny,status:403,logdata:'Malicious file upload attempted: %{matched_var}'"

# ----------------------------------------------------------------------------
# REGLAS PARA API HR PORTAL
# ----------------------------------------------------------------------------

# Rate limiting específico para API
SecRule REQUEST_URI "@beginsWith /api/" \
    "id:12001,phase:1,nolog,pass,initcol:api=%{REMOTE_ADDR}"

SecRule REQUEST_URI "@beginsWith /api/" \
    "id:12002,phase:1,block,log,msg:'API rate limit exceeded',\
    setvar:api.requests=+1,expirevar:api.requests=60,\
    chain"
    SecRule API:REQUESTS "@gt 100" \
        "t:none,deny,status:429,logdata:'API rate limit exceeded for IP: %{remote_addr}'"

# Validar Content-Type para API
SecRule REQUEST_URI "@beginsWith /api/" \
    "id:12003,phase:1,block,log,msg:'Invalid Content-Type for API',\
    chain"
    SecRule REQUEST_METHOD "@rx ^(POST|PUT|PATCH)$" \
        "chain"
    SecRule REQUEST_HEADERS:Content-Type "!^application/json" \
        "t:none,deny,status:415,logdata:'Content-Type must be application/json'"

# ----------------------------------------------------------------------------
# PROTECCIÓN DDOS BÁSICA
# ----------------------------------------------------------------------------

SecRule REQUEST_HEADERS:User-Agent "^$" \
    "id:13001,phase:1,deny,status:403,msg:'Empty User-Agent'"

# Bloquear bots conocidos
SecRule REQUEST_HEADERS:User-Agent "@rx (sqlmap|nikto|nmap|masscan|zgrab|gobuster|dirb|wfuzz)" \
    "id:13002,phase:1,deny,status:403,msg:'Scanner/bot detected',\
    logdata:'User-Agent: %{request_headers.user-agent}'"

# ============================================================================
# INCLUIR OWASP CORE RULE SET
# ============================================================================

Include /etc/modsecurity/crs/crs-setup.conf
Include /etc/modsecurity/crs/rules/*.conf

# ============================================================================
# REGLAS DE EXCLUSIÓN (FALSE POSITIVES)
# ============================================================================

# Exclusiones específicas para HR Portal
SecRuleRemoveById 920350  # Eliminar si causa problemas con IPs privadas

# Permitir ciertos caracteres en campos específicos
SecRule REQUEST_URI "@contains /api/employees/bulk-import" \
    "id:99901,phase:1,pass,nolog,ctl:ruleRemoveTargetById=942100;ARGS:csv_data"
