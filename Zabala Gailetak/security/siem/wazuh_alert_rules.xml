<!-- Wazuh Alert Rules - Zabala Gailetak -->
<!-- Custom rules for ISO 27001, GDPR, IEC 62443 compliance -->

<group name="zabala_gailetak,">

  <!-- Rule 100001: Brute Force Detection -->
  <rule id="100001" level="10" frequency="5" timeframe="60">
    <if_matched_sid>5710</if_matched_sid>
    <description>Brute force attack detected: 5 failed login attempts in 1 minute</description>
    <mitre>
      <id>T1110</id>
      <id>T1110.001</id>
    </mitre>
    <group>authentication_failures,pci_dss_10.2.4,pci_dss_10.2.5,gdpr_IV_35.7.d,gdpr_IV_32.2,hipaa_164.312.b,nist_800_53_AU.14,nist_800_53_AC.7,tsc_CC6.1,tsc_CC6.2,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

  <!-- Rule 100002: Privilege Escalation - New admin user -->
  <rule id="100002" level="13">
    <if_sid>60106</if_sid>
    <field name="win.eventdata.targetUserName">^administrator$|^Admin$</field>
    <description>Admin group modification detected: $(win.eventdata.subjectUserName) added $(win.eventdata.targetUserName) to admin group</description>
    <mitre>
      <id>T1098</id>
      <id>T1136</id>
    </mitre>
    <group>privilege_escalation,windows_security,pci_dss_10.2.5,gdpr_IV_35.7.d,gdpr_IV_32.2,hipaa_164.312.b,nist_800_53_AU.6,nist_800_53_AU.14,nist_800_53_AC.7,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

  <!-- Rule 100003: Malware Detection -->
  <rule id="100003" level="14">
    <if_sid>100001</if_sid>
    <match>malware|virus|trojan|ransomware</match>
    <description>Malware detected on endpoint: $(agent.name)</description>
    <mitre>
      <id>T1204</id>
      <id>T1204.002</id>
    </mitre>
    <group>malware,virus,trojan,pci_dss_5.1,gdpr_IV_35.7.d,hipaa_164.308.4,nist_800_53_SI.3,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

  <!-- Rule 100004: Data Exfiltration Detection -->
  <rule id="100004" level="12" frequency="10" timeframe="300">
    <if_matched_sid>57040</if_matched_sid>
    <description>Possible data exfiltration: High volume of data transferred to external IP</description>
    <mitre>
      <id>T1041</id>
      <id>T1048</id>
    </mitre>
    <group>data_exfiltration,pci_dss_10.2.1,gdpr_IV_35.7.d,hipaa_164.312.b,nist_800_53_AU.6,tsc_CC6.6,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

  <!-- Rule 100005: OT Network Anomaly - Modbus -->
  <rule id="100005" level="12">
    <decoded_as>json</decoded_as>
    <field name="ot.protocol">^modbus$</field>
    <field name="ot.function_code">^0x05$|^0x0F$</field>
    <description>OT Alert: Modbus Write operation detected from $(srcip) to PLC $(ot.device)</description>
    <mitre>
      <id>T0831</id>
      <id>T0836</id>
    </mitre>
    <group>ot_security,modbus,ics_scada,iec_62443,</group>
  </rule>

  <!-- Rule 100006: OT Network Anomaly - Unauthorized Access -->
  <rule id="100006" level="13">
    <decoded_as>json</decoded_as>
    <field name="ot.protocol">^opc_ua$|^modbus$|^dnp3$</field>
    <field name="ot.authorized">^false$</field>
    <description>CRITICAL: Unauthorized OT device access attempt from $(srcip)</description>
    <mitre>
      <id>T0830</id>
      <id>T0885</id>
    </mitre>
    <group>ot_security,unauthorized_access,ics_scada,iec_62443,</group>
  </rule>

  <!-- Rule 100007: Ransomware Activity -->
  <rule id="100007" level="14">
    <if_sid>550</if_sid>
    <match>mass file modification|encryption|ransom|bitcoin</match>
    <description>RANSOMWARE DETECTED: Mass file modification/encryption activity on $(agent.name)</description>
    <mitre>
      <id>T1486</id>
    </mitre>
    <group>ransomware,attack,pci_dss_11.4,gdpr_IV_35.7.d,hipaa_164.312.b,nist_800_53_SI.4,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

  <!-- Rule 100008: DLP - Sensitive Data Leak -->
  <rule id="100008" level="11">
    <decoded_as>json</decoded_as>
    <field name="dlp.severity">^high$|^critical$</field>
    <description>DLP Alert: Sensitive data detected in outgoing traffic - $(dlp.data_type)</description>
    <mitre>
      <id>T1048</id>
    </mitre>
    <group>dlp,data_leak,gdpr_IV_32.2,gdpr_IV_33,nist_800_53_AC.4,</group>
  </rule>

  <!-- Rule 100009: NIS2 Critical Incident Detection -->
  <rule id="100009" level="15">
    <if_sid>100001,100003,100004,100007</if_sid>
    <description>NIS2 SIGNIFICANT INCIDENT: Security breach requiring 24h notification to INCIBE</description>
    <mitre>
      <id>T1071</id>
    </mitre>
    <group>nis2,critical_incident,gdpr_IV_33,gdpr_IV_34,incibe_notification,</group>
  </rule>

  <!-- Rule 100010: File Integrity Monitoring - Critical Files -->
  <rule id="100010" level="11">
    <if_sid>550</if_sid>
    <field name="file">/etc/passwd|/etc/shadow|/etc/sudoers|C:\\Windows\\System32\\config\\SAM</field>
    <description>Critical system file modified: $(file) by $(user)</description>
    <mitre>
      <id>T1565</id>
    </mitre>
    <group>fim,critical_files,pci_dss_11.5,gdpr_IV_35.7.d,hipaa_164.312.c.1,nist_800_53_SI.7,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

</group>
