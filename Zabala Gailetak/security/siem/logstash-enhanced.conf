# Logstash Configuration for Zabala Gailetak SIEM
# Enhanced with security detection, filtering, and enrichment

input {
  # Application logs from API
  beats {
    port => 5044
    codec => json
    type => "beats"
  }
  
  # Application logs from files
  file {
    path => "/var/log/zabala-gailetak/*.log"
    start_position => "beginning"
    type => "application"
    codec => json
    tags => ["application"]
  }
  
  # Nginx access logs
  file {
    path => "/var/log/nginx/access.log"
    start_position => "beginning"
    type => "nginx-access"
    tags => ["nginx", "access"]
  }
  
  # Nginx error logs
  file {
    path => "/var/log/nginx/error.log"
    start_position => "beginning"
    type => "nginx-error"
    tags => ["nginx", "error"]
  }
  
  # MongoDB logs
  file {
    path => "/var/log/mongodb/*.log"
    start_position => "beginning"
    type => "mongodb"
    tags => ["mongodb"]
  }
  
  # Firewall logs
  tcp {
    port => 5514
    type => "firewall"
    tags => ["firewall"]
  }
  
  # Audit logs from application
  http {
    port => 8080
    codec => json
    type => "audit"
    tags => ["audit"]
  }
}

filter {
  # ==== Application Log Processing ====
  if "application" in [tags] or [type] == "application" {
    # Parse JSON if not already parsed
    if ![timestamp] {
      json {
        source => "message"
        target => "parsed"
      }
    }
    
    # Extract timestamp
    date {
      match => [ "timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss" ]
      target => "@timestamp"
    }
    
    # Add severity based on log level
    if [level] == "error" or [level] == "ERROR" {
      mutate {
        add_field => { "severity" => "high" }
        add_tag => [ "alert", "error" ]
      }
    } else if [level] == "warn" or [level] == "WARN" {
      mutate {
        add_field => { "severity" => "medium" }
        add_tag => [ "warning" ]
      }
    } else {
      mutate {
        add_field => { "severity" => "low" }
      }
    }
  }
  
  # ==== Authentication Event Detection ====
  if [event] == "auth.login.failed" or [message] =~ /login.*failed|authentication.*failed/i {
    mutate {
      add_field => { "alert_type" => "failed_login" }
      add_field => { "severity" => "medium" }
      add_tag => [ "security", "auth_failure" ]
    }
    
    # Count failed attempts from same IP
    aggregate {
      task_id => "%{client_ip}"
      code => "
        map['failed_attempts'] ||= 0
        map['failed_attempts'] += 1
        event.set('failed_attempts', map['failed_attempts'])
      "
      timeout => 300
      timeout_tags => ['_aggregatetimeout']
      push_map_as_event_on_timeout => true
      timeout_code => "
        if map['failed_attempts'] > 5
          event.set('alert_level', 'critical')
          event.set('alert_type', 'brute_force_attempt')
        end
      "
    }
  }
  
  # ==== SQL Injection Detection ====
  if [request_body] =~ /(\bOR\b|\bAND\b|--|;|'|"|\/\*|\*\/|\bUNION\b|\bSELECT\b|\bINSERT\b|\bUPDATE\b|\bDELETE\b|\bDROP\b)/i or
     [request_uri] =~ /(\bOR\b|\bAND\b|--|;|'|"|\/\*|\*\/|\bUNION\b|\bSELECT\b)/i {
    mutate {
      add_field => { "alert_type" => "sql_injection_attempt" }
      add_field => { "severity" => "critical" }
      add_tag => [ "security", "sql_injection", "attack" ]
    }
  }
  
  # ==== XSS Detection ====
  if [request_body] =~ /<script|javascript:|onerror=|onload=|<iframe|eval\(|alert\(/i or
     [request_uri] =~ /<script|javascript:|onerror=|onload=/i {
    mutate {
      add_field => { "alert_type" => "xss_attempt" }
      add_field => { "severity" => "high" }
      add_tag => [ "security", "xss", "attack" ]
    }
  }
  
  # ==== Path Traversal Detection ====
  if [request_uri] =~ /\.\.\/|\.\.\\|%2e%2e/i {
    mutate {
      add_field => { "alert_type" => "path_traversal_attempt" }
      add_field => { "severity" => "high" }
      add_tag => [ "security", "path_traversal", "attack" ]
    }
  }
  
  # ==== Command Injection Detection ====
  if [request_body] =~ /;|\||&|`|\$\(|\$\{/i {
    mutate {
      add_field => { "alert_type" => "command_injection_attempt" }
      add_field => { "severity" => "critical" }
      add_tag => [ "security", "command_injection", "attack" ]
    }
  }
  
  # ==== Nginx Log Processing ====
  if "nginx" in [tags] {
    if "access" in [tags] {
      grok {
        match => { "message" => "%{IPORHOST:client_ip} - %{DATA:user} \[%{HTTPDATE:timestamp}\] \"%{WORD:method} %{DATA:request_uri} HTTP/%{NUMBER:http_version}\" %{NUMBER:status_code:int} %{NUMBER:bytes:int} \"%{DATA:referrer}\" \"%{DATA:user_agent}\"" }
      }
      
      # Parse timestamp
      date {
        match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
        target => "@timestamp"
      }
      
      # Classify HTTP errors
      if [status_code] >= 500 {
        mutate {
          add_field => { "severity" => "high" }
          add_tag => [ "server_error" ]
        }
      } else if [status_code] >= 400 {
        mutate {
          add_field => { "severity" => "medium" }
          add_tag => [ "client_error" ]
        }
      }
      
      # Rate limiting violations
      if [status_code] == 429 {
        mutate {
          add_field => { "alert_type" => "rate_limit_exceeded" }
          add_tag => [ "security", "rate_limit" ]
        }
      }
      
      # Detect scanning activity (high volume of 404s)
      if [status_code] == 404 {
        mutate {
          add_tag => [ "not_found" ]
        }
      }
    }
    
    if "error" in [tags] {
      mutate {
        add_field => { "severity" => "high" }
        add_tag => [ "error" ]
      }
    }
  }
  
  # ==== GeoIP Enrichment ====
  if [client_ip] and [client_ip] !~ /^(10\.|172\.(1[6-9]|2[0-9]|3[0-1])\.|192\.168\.)/ {
    geoip {
      source => "client_ip"
      target => "geoip"
      fields => ["city_name", "country_name", "country_code2", "continent_code", "location", "region_name"]
    }
    
    # Alert on access from high-risk countries (customize as needed)
    if [geoip][country_code2] in ["CN", "RU", "KP", "IR"] {
      mutate {
        add_field => { "alert_type" => "suspicious_geolocation" }
        add_field => { "severity" => "medium" }
        add_tag => [ "security", "geo_suspicious" ]
      }
    }
  }
  
  # ==== User Agent Analysis ====
  if [user_agent] {
    useragent {
      source => "user_agent"
      target => "ua"
    }
    
    # Detect common attack tools
    if [user_agent] =~ /sqlmap|nikto|nmap|masscan|metasploit|burp|owasp|zap/i {
      mutate {
        add_field => { "alert_type" => "security_scanner_detected" }
        add_field => { "severity" => "high" }
        add_tag => [ "security", "scanner", "attack_tool" ]
      }
    }
    
    # Detect bots (non-browser user agents)
    if [ua][device] == "Spider" or [user_agent] =~ /bot|crawler|spider/i {
      mutate {
        add_tag => [ "bot" ]
      }
    }
  }
  
  # ==== Add metadata ====
  mutate {
    add_field => {
      "organization" => "Zabala Gailetak"
      "environment" => "${ENVIRONMENT:production}"
      "log_source" => "%{host}"
    }
    remove_field => [ "message", "host" ]
  }
  
  # ==== Throttle alerts (prevent spam) ====
  if "security" in [tags] or "attack" in [tags] {
    throttle {
      key => "%{client_ip}%{alert_type}"
      period => 300
      max_age => 600
      before_count => -1
      after_count => 5
      add_tag => [ "throttled_alert" ]
    }
  }
}

output {
  # ==== Elasticsearch Output ====
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "zabala-%{+YYYY.MM.dd}"
    user => "elastic"
    password => "${ELASTIC_PASSWORD}"
    
    # Use different indices for different log types
    document_type => "%{[@metadata][type]}"
    
    # Template for index mapping
    template => "/usr/share/logstash/templates/zabala-template.json"
    template_name => "zabala"
    template_overwrite => true
  }
  
  # ==== Critical Alerts to Separate Index ====
  if [severity] == "critical" or "attack" in [tags] {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "zabala-alerts-%{+YYYY.MM.dd}"
      user => "elastic"
      password => "${ELASTIC_PASSWORD}"
    }
  }
  
  # ==== Email Alerts for Critical Events ====
  if [severity] == "critical" and "throttled_alert" not in [tags] {
    email {
      to => "${ALERT_EMAIL:security@zabala-gailetak.com}"
      from => "siem@zabala-gailetak.com"
      subject => "ðŸš¨ CRITICAL SECURITY ALERT: %{alert_type}"
      body => "Alert Type: %{alert_type}\nSeverity: %{severity}\nSource IP: %{client_ip}\nTimestamp: %{@timestamp}\nDetails: %{alert_details}\n\nFull event:\n%{event}"
      address => "${SMTP_SERVER:smtp.zabala-gailetak.com}"
      port => ${SMTP_PORT:587}
      username => "${SMTP_USER}"
      password => "${SMTP_PASSWORD}"
      use_tls => true
    }
  }
  
  # ==== Debug Output (development only) ====
  if [@metadata][environment] == "development" {
    stdout {
      codec => rubydebug
    }
  }
}
