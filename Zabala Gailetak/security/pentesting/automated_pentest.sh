#!/bin/bash
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPORT_DIR="$SCRIPT_DIR/reports"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
REPORT_FILE="$REPORT_DIR/pentest_report_$TIMESTAMP.md"

mkdir -p "$REPORT_DIR"

echo "========================================"
echo "  Pentesting Automatizado - ER4"
echo "  Timestamp: $(date)"
echo "========================================"
echo ""

# Crear reporte header
cat > "$REPORT_FILE" << ENDOFHEADER
# Penetration Testing Report
**Fecha:** $(date)
**Target:** Zabala Gailetak HR Portal
**Tester:** Automated Pentest Suite

---

## Executive Summary

Este reporte documenta los resultados del penetration testing automatizado.

---

## Tests Ejecutados

ENDOFHEADER

# Test 1: Web Application Scanning
echo "[1/4] Escaneo de aplicación web (OWASP ZAP)..."
if command -v docker &> /dev/null; then
    bash "$SCRIPT_DIR/scan_webapp.sh" 2>&1 | tee -a "$REPORT_FILE" || echo "[!] ZAP scan falló"
else
    echo "[!] Docker no disponible, saltando ZAP scan" | tee -a "$REPORT_FILE"
fi

echo ""
# Test 2: Authentication Testing
echo "[2/4] Testing de autenticación..."
if command -v python3 &> /dev/null; then
    python3 "$SCRIPT_DIR/test_auth.py" 2>&1 | tee -a "$REPORT_FILE" || echo "[!] Auth tests fallaron"
else
    echo "[!] Python3 no disponible, saltando auth tests" | tee -a "$REPORT_FILE"
fi

echo ""
# Test 3: Network Scanning (si Nmap disponible)
echo "[3/4] Escaneo de red..."
if command -v nmap &> /dev/null; then
    echo "[*] Ejecutando Nmap scan..."
    nmap -sV -sC localhost -p 8080,5432,6379 -oN "$REPORT_DIR/nmap_$TIMESTAMP.txt" 2>&1 | tee -a "$REPORT_FILE" || echo "[!] Nmap scan falló"
else
    echo "[!] Nmap no disponible, saltando" | tee -a "$REPORT_FILE"
fi

echo ""
# Test 4: SSL/TLS Testing
echo "[4/4] Testing SSL/TLS..."
if command -v testssl &> /dev/null; then
    echo "[*] Ejecutando testssl.sh..."
    testssl --jsonfile "$REPORT_DIR/testssl_$TIMESTAMP.json" https://zabala-gailetak.infinityfreeapp.com 2>&1 | tee -a "$REPORT_FILE" || echo "[!] testssl falló"
else
    echo "[!] testssl.sh no disponible, saltando" | tee -a "$REPORT_FILE"
fi

echo ""
echo "========================================"
echo "[✓] Pentesting completo"
echo "[+] Reporte: $REPORT_FILE"
echo ""
echo "Archivos generados:"
ls -lh "$REPORT_DIR" | grep "$TIMESTAMP" || echo "Ver $REPORT_DIR para todos los reportes"
echo "========================================"
