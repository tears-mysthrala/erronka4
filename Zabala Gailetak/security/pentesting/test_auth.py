#!/usr/bin/env python3
"""
Test de seguridad de autenticación:
- Brute force protection
- MFA enforcement
- Session management
- JWT security
"""
import requests
import time
import sys

BASE_URL = "http://localhost:8080"

def test_brute_force_protection():
    print("[+] Test 1: Brute Force Protection")

    login_url = f"{BASE_URL}/api/auth/login"

    # Intentar 6 logins fallidos
    for i in range(6):
        try:
            response = requests.post(login_url, json={
                "email": "admin@zabala.eus",
                "password": f"wrong_password_{i}"
            }, timeout=5)
            print(f"    Intento {i+1}: HTTP {response.status_code}")
        except Exception as e:
            print(f"    Intento {i+1}: Error - {e}")
        time.sleep(1)

    # El 6to intento debería ser bloqueado (429 o 403)
    try:
        response = requests.post(login_url, json={
            "email": "admin@zabala.eus",
            "password": "wrong_password_final"
        }, timeout=5)
        
        if response.status_code in [429, 403]:
            print("    [✓] Brute force protection activa")
            return True
        else:
            print(f"    [!] VULNERABILIDAD: Sin protección brute force (HTTP {response.status_code})")
            return False
    except Exception as e:
        print(f"    [!] Error en verificación: {e}")
        return False

def test_mfa_enforcement():
    print("[+] Test 2: MFA Enforcement")

    # Intentar acceder a endpoint protegido sin MFA
    try:
        response = requests.get(f"{BASE_URL}/api/employees", headers={
            "Authorization": "Bearer fake_token_without_mfa"
        }, timeout=5)

        if response.status_code == 401:
            print("    [✓] MFA enforcement activo")
            return True
        else:
            print(f"    [!] VULNERABILIDAD: Sin enforcement MFA (HTTP {response.status_code})")
            return False
    except Exception as e:
        print(f"    [!] Error en test: {e}")
        return False

def test_jwt_security():
    print("[+] Test 3: JWT Security")

    # Intentar token manipulado (ejemplo conocido de jwt.io)
    fake_token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c"

    try:
        response = requests.get(f"{BASE_URL}/api/auth/me", headers={
            "Authorization": f"Bearer {fake_token}"
        }, timeout=5)

        if response.status_code == 401:
            print("    [✓] JWT validation activa")
            return True
        else:
            print(f"    [!] VULNERABILIDAD: JWT sin validar (HTTP {response.status_code})")
            return False
    except Exception as e:
        print(f"    [!] Error en test: {e}")
        return False

def test_csrf_protection():
    print("[+] Test 4: CSRF Protection")

    # Intentar POST sin CSRF token
    try:
        response = requests.post(f"{BASE_URL}/api/employees", json={
            "first_name": "Test",
            "last_name": "User"
        }, timeout=5)

        if response.status_code == 403:
            print("    [✓] CSRF protection activa")
            return True
        else:
            print(f"    [!] VULNERABILIDAD: Sin protección CSRF (HTTP {response.status_code})")
            return False
    except Exception as e:
        print(f"    [!] Error en test: {e}")
        return False

if __name__ == "__main__":
    print("=" * 50)
    print("  Authentication Security Testing")
    print("  Target: " + BASE_URL)
    print("=" * 50)

    results = []
    results.append(test_brute_force_protection())
    print()
    results.append(test_mfa_enforcement())
    print()
    results.append(test_jwt_security())
    print()
    results.append(test_csrf_protection())

    print("\n" + "=" * 50)
    passed = sum(results)
    total = len(results)
    print(f"[+] Resultado: {passed}/{total} tests pasados")

    if passed == total:
        print("[✓] Autenticación segura")
        sys.exit(0)
    else:
        print("[!] Vulnerabilidades encontradas")
        sys.exit(1)
