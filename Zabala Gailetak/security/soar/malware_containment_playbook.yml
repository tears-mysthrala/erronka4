---
################################################################################
# SOAR Playbook: Malware Containment
# Zabala Gailetak - NIS2 Compliant
# Respuesta automatizada a infecciones de malware
################################################################################

playbook:
  name: "Malware Containment and Eradication"
  version: "1.0"
  description: "Automated response for malware infections"
  nis2_category: "Significant Incident"
  response_time_sla: "1h"
  
  triggers:
    - type: edr_alert
      rule_id: "malware_detected"
      severity: ["high", "critical"]
    - type: wazuh_alert
      rule_id: "virus_detected"
    - type: sandbox_alert
      classification: "malicious"

  malware_categories:
    ransomware:
      priority: "critical"
      actions: ["isolate_immediately", "snapshot_system", "preserve_evidence"]
    trojan:
      priority: "high"
      actions: ["isolate_host", "analyze_c2"]
    spyware:
      priority: "high"
      actions: ["isolate_host", "inspect_data_exfil"]
    adware:
      priority: "low"
      actions: ["quarantine_file"]

  phases:
    ################################################################################
    # FASE 1: DETECCI√ìN Y CLASIFICACI√ìN (< 5 min)
    ################################################################################
    detection:
      steps:
        - name: "Get malware hash"
          action: "edr_get_file_hash"
          params:
            file_path: "{{ alert.file_path }}"
          output_var: "file_hash"
          
        - name: "Query threat intelligence"
          action: "virustotal_lookup"
          params:
            hash: "{{ file_hash }}"
          output_var: "vt_results"
          
        - name: "Classify malware"
          action: "classify_malware"
          params:
            hash: "{{ file_hash }}"
            signatures: "{{ alert.signatures }}"
          output_var: "malware_classification"
          
        - name: "Calculate risk score"
          action: "calculate_risk"
          params:
            host_criticality: "{{ asset.criticality }}"
            malware_type: "{{ malware_classification.type }}"
            detection_count: "{{ vt_results.positives }}"
          output_var: "risk_score"

    ################################################################################
    # FASE 2: CONTENCI√ìN (< 15 min)
    ################################################################################
    containment:
      steps:
        - name: "Isolate affected host"
          action: "edr_isolate_host"
          params:
            hostname: "{{ alert.hostname }}"
            method: "network_quarantine"
            allow_list: ["10.10.10.10"]  # EDR server
            
        - name: "Block file hash globally"
          action: "block_file_hash"
          params:
            hash: "{{ file_hash }}"
            scope: "organization"
            
        - name: "Block C2 domains"
          action: "dns_block_domains"
          params:
            domains: "{{ vt_results.detected_urls }}"
            duration: "indefinite"
          condition: "{{ vt_results.detected_urls | length > 0 }}"
          
        - name: "Block C2 IPs"
          action: "firewall_block_ips"
          params:
            ips: "{{ vt_results.detected_ips }}"
            duration: "indefinite"
          condition: "{{ vt_results.detected_ips | length > 0 }}"
          
        - name: "Search for file across organization"
          action: "edr_hunt_file"
          params:
            hash: "{{ file_hash }}"
            scope: "all_endpoints"
          output_var: "infected_hosts"
          
        - name: "Isolate all infected hosts"
          action: "edr_isolate_host"
          params:
            hostnames: "{{ infected_hosts }}"
          condition: "{{ infected_hosts | length > 0 }}"
          
        - name: "Notify SOC"
          action: "slack_notification"
          params:
            channel: "#security-incidents"
            message: |
              ü¶† MALWARE DETECTED - {{ malware_classification.type | upper }}
              Host: {{ alert.hostname }}
              User: {{ alert.username }}
              File: {{ alert.file_path }}
              Hash: {{ file_hash }}
              Risk Score: {{ risk_score }}/100
              Actions: Host isolated, hash blocked globally
              Infected hosts found: {{ infected_hosts | length }}

    ################################################################################
    # FASE 3: AN√ÅLISIS FORENSE (< 1h)
    ################################################################################
    forensics:
      steps:
        - name: "Create memory dump"
          action: "edr_memory_dump"
          params:
            hostname: "{{ alert.hostname }}"
            output_path: "/forensics/{{ incident.id }}/memory.dmp"
            
        - name: "Collect system artifacts"
          action: "collect_artifacts"
          params:
            hostname: "{{ alert.hostname }}"
            artifacts:
              - "prefetch"
              - "mft"
              - "registry"
              - "event_logs"
              - "browser_history"
            output_path: "/forensics/{{ incident.id }}/"
            
        - name: "Analyze persistence mechanisms"
          action: "analyze_persistence"
          params:
            hostname: "{{ alert.hostname }}"
            
        - name: "Check lateral movement"
          action: "edr_query"
          params:
            query: |
              hostname={{ alert.hostname }} 
              (process_parent={{ alert.process_name }} OR 
               network_connections.outbound=true)
            timeframe: "-24h"
            
        - name: "Preserve evidence"
          action: "backup_evidence"
          params:
            source: "/forensics/{{ incident.id }}/"
            destination: "s3://forensics-backup/{{ incident.id }}/"
            encryption: "aes-256"

    ################################################################################
    # FASE 4: ERRADICACI√ìN (< 2h)
    ################################################################################
    eradication:
      steps:
        - name: "Kill malicious processes"
          action: "edr_kill_process"
          params:
            process_names: "{{ alert.processes }}"
            force: true
            
        - name: "Delete malware files"
          action: "edr_delete_file"
          params:
            file_paths: "{{ alert.files }}"
            secure_delete: true
            
        - name: "Remove persistence"
          action: "remove_persistence"
          params:
            hostname: "{{ alert.hostname }}"
            persistence_items: "{{ analysis.persistence_mechanisms }}"
            
        - name: "Clean registry entries"
          action: "registry_clean"
          params:
            keys: "{{ analysis.registry_entries }}"
            
        - name: "Full AV scan"
          action: "antivirus_scan"
          params:
            hostname: "{{ alert.hostname }}"
            scan_type: "full"
            
        - name: "Delete from all endpoints"
          action: "edr_delete_file"
          params:
            file_paths: "{{ infected_hosts.files }}"
            scope: "organization"
          condition: "{{ infected_hosts | length > 0 }}"

    ################################################################################
    # FASE 5: RECUPERACI√ìN (< 4h)
    ################################################################################
    recovery:
      steps:
        - name: "Verify system clean"
          action: "edr_verify_clean"
          params:
            hostname: "{{ alert.hostname }}"
            checks:
              - "no_malicious_processes"
              - "no_suspicious_connections"
              - "av_clean_scan"
              
        - name: "Re-enable network"
          action: "edr_unisolate_host"
          params:
            hostname: "{{ alert.hostname }}"
          condition: "{{ verify_clean.status == 'clean' }}"
          
        - name: "Force password reset"
          action: "ad_reset_password"
          params:
            username: "{{ alert.username }}"
            notify_user: true
            
        - name: "Enable enhanced monitoring"
          action: "enable_monitoring"
          params:
            hostname: "{{ alert.hostname }}"
            duration: "7d"
            level: "high"

    ################################################################################
    # FASE 6: POST-INCIDENTE
    ################################################################################
    post_incident:
      steps:
        - name: "Generate IOC list"
          action: "generate_iocs"
          params:
            indicators:
              hashes: "{{ file_hash }}"
              domains: "{{ vt_results.detected_urls }}"
              ips: "{{ vt_results.detected_ips }}"
              mutexes: "{{ analysis.mutexes }}"
              
        - name: "Update threat intelligence"
          action: "ti_update_feed"
          params:
            iocs: "{{ generate_iocs.output }}"
            feed: "active_response"
            
        - name: "Hunt for similar threats"
          action: "threat_hunt"
          params:
            indicators: "{{ generate_iocs.output }}"
            scope: "organization"
            timeframe: "-30d"
            
        - name: "NIS2 Assessment"
          action: "nis2_assess"
          params:
            incident_type: "malware"
            impact: "{{ incident.impact }}"
            
        - name: "Generate final report"
          action: "report_generate"
          params:
            template: "malware_incident_report"
            include:
              - timeline
              - iocs
              - affected_systems
              - actions_taken
              - lessons_learned

  escalation:
    criteria:
      - condition: "{{ malware_classification.type == 'ransomware' }}"
        action: "escalate_to_crisis_team"
        notify: ["ciso", "ceo", "legal"]
      - condition: "{{ infected_hosts | length > 10 }}"
        action: "escalate_to_crisis_team"
        notify: ["ciso"]
      - condition: "{{ alert.hostname in critical_servers }}"
        action: "escalate_immediately"
        notify: ["ciso", "it_director"]
