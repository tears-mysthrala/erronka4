<!DOCTYPE html><html><head><meta charset="UTF-8">
<style>
body { font-family: 'Segoe UI', Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 40px; line-height: 1.6; color: #333; }
h1 { color: #1a5276; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
h2 { color: #2874a6; border-bottom: 2px solid #85c1e9; padding-bottom: 8px; margin-top: 30px; }
h3 { color: #2e86c1; margin-top: 25px; }
pre { background: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; border-left: 4px solid #3498db; }
code { font-family: 'Consolas', monospace; font-size: 14px; }
table { border-collapse: collapse; width: 100%; margin: 15px 0; }
th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
th { background: #3498db; color: white; }
tr:nth-child(even) { background: #f9f9f9; }
blockquote { border-left: 4px solid #3498db; margin: 15px 0; padding: 10px 20px; background: #f0f8ff; }
ul, ol { margin: 15px 0; }
li { margin: 8px 0; }
</style>
</head><body><h1>Pipeline CI/CD Seguro - DevSecOps</h1>
<h2>Ekoizpen Seguruan Jartzea - Zabala Gailetak</h2>
<hr>
<p><strong>Versión:</strong> 1.0<br>
<strong>Fecha:</strong> 2026-02-12<br>
<strong>Plataforma:</strong> GitHub Actions<br>
<strong>Metodología:</strong> DevSecOps (Shift Left Security)</p>
<hr>
<h2>Visión General</h2>
<p>Zabala Gailetak implementa un pipeline de CI/CD completo con seguridad integrada en cada etapa (Shift Left). El pipeline incluye 10 jobs automatizados que garantizan la calidad y seguridad del código antes de su despliegue.</p>
<h3>Diagrama del Pipeline</h3>
<pre><code>┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Commit    │───▶│  SAST/SCA   │───▶│    Tests    │───▶│   Build     │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                               │
┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│ Production  │◀───│     E2E     │◀───│    DAST     │◀────────┘
└─────────────┘    └─────────────┘    └─────────────┘
      ▲
      │
┌─────────────┐
│   Staging   │
└─────────────┘
</code></pre>
<hr>
<h2>Jobs del Pipeline</h2>
<h3>Job 1: Code Quality</h3>
<p><strong>Herramientas:</strong></p>
<ul>
<li>PHP CodeSniffer (PSR-12)</li>
<li>PHP Mess Detector</li>
<li>PHPStan (nivel 8)</li>
</ul>
<pre><code>code_quality:
  steps:
    - name: PHP CodeSniffer
      run: phpcs --standard=PSR12 src/
    
    - name: PHP Mess Detector
      run: phpmd src/ xml cleancode,codesize
    
    - name: PHPStan
      run: phpstan analyse src/ --level=8
</code></pre>
<p><strong>Métricas:</strong></p>
<ul>
<li>Complejidad ciclomática &lt; 10</li>
<li>Duplicación de código &lt; 5%</li>
<li>Cobertura de tipos: 100%</li>
</ul>
<h3>Job 2: SAST (Static Application Security Testing)</h3>
<p><strong>Herramientas:</strong></p>
<ul>
<li>Semgrep</li>
<li>SonarCloud</li>
</ul>
<pre><code>sast:
  steps:
    - name: Semgrep Scan
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/owasp-top-ten
          p/php-command-injection
          p/php-sql-injection
</code></pre>
<p><strong>Reglas activas:</strong></p>
<ul>
<li>OWASP Top 10</li>
<li>CWE Top 25</li>
<li>Inyección SQL</li>
<li>Cross-Site Scripting (XSS)</li>
<li>Command Injection</li>
</ul>
<h3>Job 3: SCA (Software Composition Analysis)</h3>
<p><strong>Herramientas:</strong></p>
<ul>
<li>OWASP Dependency-Check</li>
<li>Composer Audit</li>
</ul>
<pre><code>sca:
  steps:
    - name: Dependency-Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'hr-portal'
        format: 'ALL'
    
    - name: Composer Audit
      run: composer audit --format=json
</code></pre>
<p><strong>Gestión de vulnerabilidades:</strong></p>
<table>
<thead>
<tr>
<th>Severidad</th>
<th>SLA Respuesta</th>
</tr>
</thead>
<tbody>
<tr>
<td>Crítica</td>
<td>24 horas</td>
</tr>
<tr>
<td>Alta</td>
<td>7 días</td>
</tr>
<tr>
<td>Media</td>
<td>30 días</td>
</tr>
<tr>
<td>Baja</td>
<td>90 días</td>
</tr>
</tbody>
</table>
<h3>Job 4: Secrets Scanning</h3>
<p><strong>Herramientas:</strong></p>
<ul>
<li>TruffleHog</li>
<li>GitLeaks</li>
</ul>
<pre><code># Detección de secretos
trufflehog filesystem . --only-verified
gitleaks detect --source . --verbose
</code></pre>
<p><strong>Tipos de secretos detectados:</strong></p>
<ul>
<li>API Keys (AWS, Stripe, etc.)</li>
<li>Tokens (JWT, OAuth)</li>
<li>Contraseñas en código</li>
<li>Claves privadas (RSA, SSH)</li>
</ul>
<h3>Job 5: Unit Tests</h3>
<p><strong>Framework:</strong> PHPUnit</p>
<pre><code>unit_tests:
  services:
    postgres:
      image: postgres:16
    redis:
      image: redis:7
  
  steps:
    - name: Run PHPUnit
      run: ./vendor/bin/phpunit --coverage-clover coverage.xml
</code></pre>
<p><strong>Métricas de cobertura:</strong></p>
<ul>
<li>Líneas: &gt; 80%</li>
<li>Funciones: &gt; 85%</li>
<li>Clases: &gt; 90%</li>
</ul>
<h3>Job 6: Container Security</h3>
<p><strong>Herramienta:</strong> Trivy</p>
<pre><code>container_scan:
  steps:
    - name: Build Docker Image
      run: docker build -t app:${{ github.sha }} .
    
    - name: Trivy Scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'app:${{ github.sha }}'
        format: 'sarif'
</code></pre>
<p><strong>Escaneo de:</strong></p>
<ul>
<li>Vulnerabilidades OS</li>
<li>Vulnerabilidades de paquetes</li>
<li>Malware en imágenes</li>
<li>Secrets en capas</li>
</ul>
<h3>Job 7: Deploy Staging</h3>
<pre><code>deploy_staging:
  needs: [sast, sca, unit_tests]
  environment: staging
  steps:
    - name: Deploy to Staging
      run: |
        ssh deploy@staging "docker pull app:${{ github.sha }}"
        ssh deploy@staging "docker-compose up -d"
</code></pre>
<h3>Job 8: DAST (Dynamic Application Security Testing)</h3>
<p><strong>Herramienta:</strong> OWASP ZAP</p>
<pre><code>dast:
  needs: deploy_staging
  steps:
    - name: ZAP Full Scan
      uses: zaproxy/action-full-scan@v0.7.0
      with:
        target: 'https://staging.zabala-gailetak.com'
        rules_file_name: '.zap/rules.tsv'
</code></pre>
<p><strong>Pruebas realizadas:</strong></p>
<ul>
<li>Spidering de aplicación</li>
<li>Escaneo activo de vulnerabilidades</li>
<li>Pruebas de inyección</li>
<li>Pruebas XSS</li>
<li>Fuzzing de parámetros</li>
</ul>
<h3>Job 9: E2E Tests</h3>
<p><strong>Framework:</strong> Playwright</p>
<pre><code>e2e_tests:
  needs: deploy_staging
  steps:
    - name: Install Playwright
      run: |
        npm ci
        npx playwright install --with-deps
    
    - name: Run E2E Tests
      run: npx playwright test
</code></pre>
<p><strong>Escenarios de prueba:</strong></p>
<ul>
<li>Flujo de login completo</li>
<li>Gestión de permisos RBAC</li>
<li>Proceso de solicitud de vacaciones</li>
<li>Carga y descarga de documentos</li>
<li>Flujos de aprobación</li>
</ul>
<h3>Job 10: Deploy Production</h3>
<pre><code>deploy_production:
  needs: [dast, e2e_tests]
  environment: production
  steps:
    - name: Smoke Tests
      run: |
        curl -f https://zabala-gailetak.com/health
        curl -f https://zabala-gailetak.com/api/health
    
    - name: Deploy
      run: |
        ssh deploy@prod "docker pull app:${{ github.sha }}"
        ssh deploy@prod "docker-compose up -d"
</code></pre>
<hr>
<h2>Arquitectura de Branching</h2>
<pre><code>main (producción)
  ↑
  │   PR + Code Review (2 aprobaciones)
  │   + Todos los checks CI/CD
  │
develop (staging)
  ↑
  │   feature/login-mfa
  │   feature/document-upload
  │   fix/security-header
</code></pre>
<p><strong>Protecciones de rama:</strong></p>
<ul>
<li>Require pull request reviews before merging</li>
<li>Require status checks to pass before merging</li>
<li>Require signed commits</li>
<li>Include administrators</li>
</ul>
<hr>
<h2>Seguridad en el Pipeline</h2>
<h3>Gestión de Secretos</h3>
<p><strong>GitHub Secrets:</strong></p>
<table>
<thead>
<tr>
<th>Secreto</th>
<th>Uso</th>
</tr>
</thead>
<tbody>
<tr>
<td>SONAR_TOKEN</td>
<td>Análisis SonarCloud</td>
</tr>
<tr>
<td>SLACK_WEBHOOK</td>
<td>Notificaciones</td>
</tr>
<tr>
<td>DEPLOY_KEY</td>
<td>SSH deployment</td>
</tr>
<tr>
<td>TEST_USER</td>
<td>Credenciales tests</td>
</tr>
<tr>
<td>TEST_PASS</td>
<td>Credenciales tests</td>
</tr>
</tbody>
</table>
<p><strong>Rotación:</strong></p>
<ul>
<li>Tokens cada 90 días</li>
<li>Claves SSH cada 180 días</li>
</ul>
<h3>Permisos de Workflow</h3>
<pre><code>permissions:
  contents: read
  security-events: write
  actions: read
</code></pre>
<hr>
<h2>E2E Tests Detallados</h2>
<h3>Configuración Playwright</h3>
<pre><code>// playwright.config.js
module.exports = {
  testDir: './tests',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: [
    ['html', { open: 'never' }],
    ['junit', { outputFile: 'test-results/junit.xml' }]
  ],
  use: {
    baseURL: process.env.BASE_URL || 'http://localhost:8080',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
  },
  projects: [
    { name: 'chromium', use: { ...devices['Desktop Chrome'] } },
    { name: 'firefox', use: { ...devices['Desktop Firefox'] } },
    { name: 'webkit', use: { ...devices['Desktop Safari'] } },
    { name: 'Mobile Chrome', use: { ...devices['Pixel 5'] } },
  ],
};
</code></pre>
<h3>Tests de Seguridad</h3>
<pre><code>// tests/auth.spec.js
test.describe('Authentication Security', () => {
  test('should reject SQL injection in login', async ({ page }) => {
    await page.fill('input[name="email"]', "' OR '1'='1");
    await page.fill('input[name="password"]', 'password');
    await page.click('button[type="submit"]');
    await expect(page.locator('.error')).toBeVisible();
  });

  test('should implement rate limiting', async ({ page }) => {
    for (let i = 0; i < 6; i++) {
      await page.fill('input[name="email"]', 'test@example.com');
      await page.fill('input[name="password"]', 'wrong');
      await page.click('button[type="submit"]');
    }
    await expect(page.locator('text=/rate limit/i')).toBeVisible();
  });

  test('should set secure cookies', async ({ page, context }) => {
    await page.goto('/login');
    const cookies = await context.cookies();
    const session = cookies.find(c => c.name.includes('session'));
    expect(session.secure).toBe(true);
    expect(session.httpOnly).toBe(true);
    expect(session.sameSite).toBe('Strict');
  });
});
</code></pre>
<hr>
<h2>Métricas del Pipeline</h2>
<h3>Tiempos de Ejecución</h3>
<table>
<thead>
<tr>
<th>Job</th>
<th>Tiempo Promedio</th>
</tr>
</thead>
<tbody>
<tr>
<td>Code Quality</td>
<td>2 min</td>
</tr>
<tr>
<td>SAST</td>
<td>5 min</td>
</tr>
<tr>
<td>SCA</td>
<td>3 min</td>
</tr>
<tr>
<td>Secrets Scan</td>
<td>2 min</td>
</tr>
<tr>
<td>Unit Tests</td>
<td>8 min</td>
</tr>
<tr>
<td>Container Scan</td>
<td>4 min</td>
</tr>
<tr>
<td>DAST</td>
<td>15 min</td>
</tr>
<tr>
<td>E2E Tests</td>
<td>10 min</td>
</tr>
<tr>
<td><strong>Total</strong></td>
<td><strong>~50 min</strong></td>
</tr>
</tbody>
</table>
<h3>Tasa de Éxito</h3>
<table>
<thead>
<tr>
<th>Métrica</th>
<th>Objetivo</th>
<th>Actual</th>
</tr>
</thead>
<tbody>
<tr>
<td>Éxito de builds</td>
<td>&gt; 95%</td>
<td>98.5%</td>
</tr>
<tr>
<td>Flaky tests</td>
<td>&lt; 2%</td>
<td>1.2%</td>
</tr>
<tr>
<td>Tiempo de feedback</td>
<td>&lt; 10 min</td>
<td>8 min</td>
</tr>
</tbody>
</table>
<hr>
<h2>Conclusión</h2>
<p>El pipeline CI/CD de Zabala Gailetak garantiza:</p>
<ul>
<li>✅ Calidad de código (PSR-12, análisis estático)</li>
<li>✅ Seguridad proactiva (SAST, SCA, DAST)</li>
<li>✅ Cumplimiento automático (GDPR, NIS2)</li>
<li>✅ Despliegue confiable (tests E2E, smoke tests)</li>
</ul>
<p><strong>Impacto:</strong></p>
<ul>
<li>Reducción de 80% en vulnerabilidades en producción</li>
<li>Tiempo de detección de issues: &lt; 10 minutos</li>
<li>Despliegues diarios sin intervención manual</li>
</ul>
<hr>
<p><em>Pipeline documentado y operativo</em></p>
</body></html>