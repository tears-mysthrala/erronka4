name: Secure CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run security scans nightly
    - cron: '0 2 * * *'

env:
  PHP_VERSION: '8.4'
  NODE_VERSION: '20'

jobs:
  # ==========================================
  # JOB 1: Code Quality & Linting
  # ==========================================
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
        extensions: mbstring, intl, pdo_pgsql, redis
        tools: phpcs, phpmd, phpstan
    
    - name: PHP CodeSniffer (PSR-12)
      run: |
        cd "Zabala Gailetak/hr-portal"
        phpcs --standard=PSR12 src/ --report=checkstyle --report-file=phpcs-report.xml || true
    
    - name: PHP Mess Detector
      run: |
        cd "Zabala Gailetak/hr-portal"
        phpmd src/ xml codesize,cleancode,controversial,design,naming,unusedcode --reportfile phpmd-report.xml || true
    
    - name: PHPStan Static Analysis
      run: |
        cd "Zabala Gailetak/hr-portal"
        phpstan analyse src/ --level=8 --error-format=table || true
    
    - name: Upload Code Quality Reports
      uses: actions/upload-artifact@v4
      with:
        name: code-quality-reports
        path: |
          Zabala Gailetak/hr-portal/phpcs-report.xml
          Zabala Gailetak/hr-portal/phpmd-report.xml

  # ==========================================
  # JOB 2: SAST - Static Application Security Testing
  # ==========================================
  sast:
    name: SAST Scanning
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Semgrep Security Scanner
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/owasp-top-ten
          p/cwe-top-25
          p/php-command-injection
          p/php-sql-injection
          p/php-xss
        generateSarif: "1"
    
    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        projectBaseDir: "Zabala Gailetak/hr-portal"
        args: >
          -Dsonar.organization=zabala-gailetak
          -Dsonar.projectKey=zabala_hr_portal
          -Dsonar.sources=src/
          -Dsonar.tests=tests/
          -Dsonar.php.coverage.reportPaths=coverage.xml
    
    - name: Upload Semgrep SARIF
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: semgrep.sarif
      if: always()

  # ==========================================
  # JOB 3: SCA - Software Composition Analysis
  # ==========================================
  sca:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
    
    - name: Install Composer Dependencies
      run: |
        cd "Zabala Gailetak/hr-portal"
        composer install --no-dev --optimize-autoloader
    
    - name: OWASP Dependency-Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'hr-portal'
        path: 'Zabala Gailetak/hr-portal'
        format: 'ALL'
        args: >
          --enableExperimental
          --enableRetired
    
    - name: Composer Audit
      run: |
        cd "Zabala Gailetak/hr-portal"
        composer audit --format=json > composer-audit.json || true
    
    - name: Upload Dependency Check Report
      uses: actions/upload-artifact@v4
      with:
        name: dependency-check-report
        path: reports/

  # ==========================================
  # JOB 4: Secrets Scanning
  # ==========================================
  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: TruffleHog OSS
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified
    
    - name: GitLeaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================
  # JOB 5: Unit Tests
  # ==========================================
  unit-tests:
    name: PHPUnit Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: hr_portal_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        ports:
          - 6379:6379
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup PHP with Coverage
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
        coverage: xdebug
        extensions: mbstring, intl, pdo_pgsql, redis
    
    - name: Install Dependencies
      run: |
        cd "Zabala Gailetak/hr-portal"
        composer install
    
    - name: Run PHPUnit with Coverage
      run: |
        cd "Zabala Gailetak/hr-portal"
        ./vendor/bin/phpunit --coverage-clover coverage.xml --coverage-html coverage-html
      env:
        DB_HOST: localhost
        DB_PORT: 5432
        DB_NAME: hr_portal_test
        DB_USER: test
        DB_PASS: test
        REDIS_HOST: localhost
    
    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: Zabala Gailetak/hr-portal/coverage.xml
        flags: unittests
        name: codecov-umbrella
    
    - name: Upload Coverage Report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: Zabala Gailetak/hr-portal/coverage-html/

  # ==========================================
  # JOB 6: Build & Container Security
  # ==========================================
  container-security:
    name: Container Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Docker Image
      run: |
        docker build -t zabala-hr-portal:${{ github.sha }} "Zabala Gailetak/hr-portal"
    
    - name: Trivy Container Scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'zabala-hr-portal:${{ github.sha }}'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Upload Trivy Results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

  # ==========================================
  # JOB 7: Deploy to Staging
  # ==========================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [code-quality, sast, sca, unit-tests]
    if: github.ref == 'refs/heads/develop'
    environment: staging
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to Staging Server
      run: |
        echo "Deploying to staging environment..."
        # Actual deployment steps would go here
        # scp, ssh, etc.

  # ==========================================
  # JOB 8: DAST - Dynamic Application Security Testing
  # ==========================================
  dast:
    name: DAST Scan (OWASP ZAP)
    runs-on: ubuntu-latest
    needs: deploy-staging
    
    steps:
    - name: ZAP Full Scan
      uses: zaproxy/action-full-scan@v0.7.0
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        docker_name: 'ghcr.io/zaproxy/zaproxy:stable'
        target: 'https://staging.zabala-gailetak.com'
        rules_file_name: '.zap/rules.tsv'
        cmd_options: '-a'
    
    - name: Upload ZAP Report
      uses: actions/upload-artifact@v4
      with:
        name: zap-report
        path: report_*

  # ==========================================
  # JOB 9: E2E Tests with Playwright
  # ==========================================
  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    needs: deploy-staging
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: Install Playwright
      run: |
        cd "Zabala Gailetak/tests/e2e"
        npm ci
        npx playwright install --with-deps
    
    - name: Run Playwright Tests
      run: |
        cd "Zabala Gailetak/tests/e2e"
        npx playwright test
      env:
        BASE_URL: https://staging.zabala-gailetak.com
        TEST_USER: ${{ secrets.TEST_USER }}
        TEST_PASS: ${{ secrets.TEST_PASS }}
    
    - name: Upload Playwright Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: |
          Zabala Gailetak/tests/e2e/playwright-report/
          Zabala Gailetak/tests/e2e/test-results/

  # ==========================================
  # JOB 10: Production Deploy (Manual Approval)
  # ==========================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [dast, e2e-tests]
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to Production
      run: |
        echo "Deploying to production..."
        # Production deployment steps
    
    - name: Smoke Tests
      run: |
        curl -f https://zabala-gailetak.com/health || exit 1
        curl -f https://zabala-gailetak.com/api/health || exit 1
