################################################################################
# Docker Compose - Zabala Gailetak HR Portal
# Stack completo con seguridad hardened
# NIS2 / ISO 27001 / IEC 62443 Compliant
################################################################################

version: '3.8'

services:
  # ==========================================================================
  # REVERSE PROXY / WAF
  # ==========================================================================
  nginx:
    image: nginx:1.25-alpine
    container_name: zg_nginx
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    read_only: true
    tmpfs:
      - /var/cache/nginx:noexec,nosuid,size=100m
      - /var/run:noexec,nosuid,size=10m
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/security.conf:/etc/nginx/conf.d/security.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./public:/var/www/html/public:ro
      - nginx_cache:/var/cache/nginx
    ports:
      - "80:80"
      - "443:443"
    networks:
      - frontend
      - backend
    depends_on:
      - php
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ==========================================================================
  # APLICACIÓN PHP
  # ==========================================================================
  php:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: production
    container_name: zg_php
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_DATABASE=hr_portal
      - DB_USERNAME=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
    volumes:
      - ../src:/var/www/html/src:ro
      - ../config:/var/www/html/config:ro
      - ../public:/var/www/html/public:ro
      - uploads:/var/www/html/storage/uploads
      - logs:/var/www/html/storage/logs
      - cache:/var/www/html/storage/cache
    networks:
      - backend
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "php-fpm-healthcheck || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================================================
  # BASE DE DATOS POSTGRESQL
  # ==========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: zg_postgres
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    environment:
      - POSTGRES_DB=hr_portal
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_INITDB_ARGS=--auth-host=scram-sha-256
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init:/docker-entrypoint-initdb.d:ro
      - ./postgres/ssl:/var/lib/postgresql/ssl:ro
      - ./postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro
    command: >
      postgres 
      -c ssl=on 
      -c ssl_cert_file=/var/lib/postgresql/ssl/server.crt
      -c ssl_key_file=/var/lib/postgresql/ssl/server.key
      -c ssl_ca_file=/var/lib/postgresql/ssl/ca.crt
      -c password_encryption=scram-sha-256
      -c log_connections=on
      -c log_disconnections=on
      -c log_statement=ddl
      -c log_min_duration_statement=1000
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d hr_portal"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================================
  # CACHE / SESSION STORE (REDIS)
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: zg_redis
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --bind 0.0.0.0
      --protected-mode yes
    volumes:
      - redis_data:/data
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      - backend
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================================
# BACKUP AUTOMÁTICO
  # ==========================================================================
  backup:
    image: offen/docker-volume-backup:v2
    container_name: zg_backup
    restart: unless-stopped
    environment:
      - BACKUP_CRON_EXPRESSION=0 2 * * *
      - BACKUP_RETENTION_DAYS=30
      - BACKUP_FILENAME=hr-portal-backup-%Y-%m-%dT%H-%M-%S.tar.gz
      - BACKUP_ARCHIVE=/archive
      - BACKUP_STOP_CONTAINER_LABEL=backup.stop
      - BACKUP_STOP_TIMEOUT=300
      - AWS_S3_BUCKET_NAME=${BACKUP_S3_BUCKET}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_KEY}
      - AWS_DEFAULT_REGION=eu-west-1
      - NOTIFICATION_URLS=${BACKUP_NOTIFICATION_URL}
    volumes:
      - postgres_data:/backup/postgres:ro
      - uploads:/backup/uploads:ro
      - ./backups:/archive
    networks:
      - backend
    labels:
      - backup.stop=true

  # ==========================================================================
  # MONITOREO (PROMETHEUS NODE EXPORTER)
  # ==========================================================================
  node-exporter:
    image: prom/node-exporter:v1.7
    container_name: zg_node_exporter
    restart: unless-stopped
    command:
      - '--path.procfs=/host/proc'
      - '--path.rootfs=/rootfs'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    networks:
      - backend
    profiles:
      - monitoring

# ==========================================================================
# NETWORKS
# ==========================================================================
networks:
  frontend:
    driver: bridge
    internal: false
    ipam:
      config:
        - subnet: 172.20.0.0/24
  backend:
    driver: bridge
    internal: true  # Sin acceso externo
    ipam:
      config:
        - subnet: 172.20.1.0/24

# ==========================================================================
# VOLUMES
# ==========================================================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  uploads:
    driver: local
  logs:
    driver: local
  cache:
    driver: local
  nginx_cache:
    driver: local
